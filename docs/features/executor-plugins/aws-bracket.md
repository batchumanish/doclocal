---
title: AWS Braket Executor
---
import Typography from '@mui/material/Typography';
import aws from '@site/static/img/executorAssets/AWS_Batch.jpg';

<img src={aws}/>


Covalent is a Pythonic workflow tool used to execute tasks on advanced computing hardware.

This plugin allows executing quantum circuits and quantum-classical hybrid jobs in Amazon Braket when you use Covalent.

## 1. Installation

To use this plugin with Covalent, simply install it using `pip`:

```bash
pip install covalent-braket-plugin
```

## 2. Usage Example
The following toy example executes a simple quantum circuit on one qubit that prepares a uniform superposition of the standard basis states and then measures the state. We use the [Pennylane](https://pennylane.ai/) framework.

```py
import covalent as ct
from covalent_braket_plugin.braket import BraketExecutor
import os

# AWS resources to pass to the executor
credentials = "~/.aws/credentials"
profile = "default"
    region = "us-east-1"
s3_bucket_name = "braket_s3_bucket"
ecr_repo_name = "braket_ecr_repo"
iam_role_name = "covalent-braket-iam-role"

# Instantiate the executor
ex = BraketExecutor(
            profile=profile,
            credentials=credentials_file,
            s3_bucket_name=s3_bucket_name,
            ecr_image_uri=ecr_image_uri,
            braket_job_execution_role_name=iam_role_name,
            quantum_device="arn:aws:braket:::device/quantum-simulator/amazon/sv1",
            classical_device="ml.m5.large",
            storage=30,
            time_limit=300,
    )


# Execute the following circuit:
# |0> - H - Measure
@ct.electron(executor=ex)
def simple_quantum_task(num_qubits: int):
    import pennylane as qml

    # These are passed to the Hybrid Jobs container at runtime
    device_arn = os.environ["AMZN_BRAKET_DEVICE_ARN"]
    s3_bucket = os.environ["AMZN_BRAKET_OUT_S3_BUCKET"]
    s3_task_dir = os.environ["AMZN_BRAKET_TASK_RESULTS_S3_URI"].split(s3_bucket)[1]

    device = qml.device(
        "braket.aws.qubit",
        device_arn=device_arn,
        s3_destination_folder=(s3_bucket, s3_task_dir),
        wires=num_qubits,
    )

    @qml.qnode(device=device)
    def simple_circuit():
        qml.Hadamard(wires=[0])
        return qml.expval(qml.PauliZ(wires=[0]))

    res = simple_circuit().numpy()
    return res


@ct.lattice
def simple_quantum_workflow(num_qubits: int):
    return simple_quantum_task(num_qubits=num_qubits)


dispatch_id = ct.dispatch(simple_quantum_workflow)(1)
result_object = ct.get_result(dispatch_id, wait=True)

# We expect 0 as the result
print("Result:", result_object.result)
```

During the execution of the workflow one can navigate to the UI to see the status of the workflow, once completed however the above script should also output a value with the output of the quantum measurement.

```py
>>> Result: 0
```

## 3. Overview of Configuration

| Config Value | Is Required |  Default| Description |
| ------------ | ----------- | ------- | ----------- |
| credentials| No    | “~/.aws/credentials”       | The path to the AWS credentials file |
| braket_job_execution_role_name| Yes  | “CovalentBraketJobsExecutionRole”        | The name of the IAM role that Braket will assume during task execution. |
| profile| No  |  “default” | The path to your AWS credentials file |
| region | Yes  |  :code`AWS_DEFAULT_REGION` environment variable | AWS Region to use to for client calls to AWS |
| s3_bucket_name | Yes  |  amazon-braket-covalent-job-resources | The S3 bucket where Covalent will store input and output files for the task. |
| ecr_image_uri | Yes  |    | An ECR repository for storing container images to be run by Braket. |
| quantum_device | No  |  “arn:aws:braket:::device/quantum-simulator/amazon/sv1” | The ARN of the quantum device to use |
| classical_device | No  |  “ml.m5.large” | Instance type for the classical device to use |
| storage | No  |  30 | Storage size in GB for the classical device |
| time_limit | No  |  300 | Max running time in seconds for the Braket job |
| poll_freq | No  |  30 | How often (in seconds) to poll Braket for the job status |
| cache_dir | No  |  “/tmp/covalent” | Location for storing temporary files generated by the Covalent server |

This plugin can be configured in one of two ways:

1. Configuration options can be passed in as constructor keys to the executor class `ct.executor.BraketExecutor`
2. By modifying the [covalent configuration file](#) under the section `[executors.braket]`


The following shows an example of how a user might modify their [covalent configuration file](#) to support this plugin:


<!-- We need to add a document in this link page https://covalent.readthedocs.io/en/latest/how_to/config/customization.html -->

```py
[executors.braket]
quantum_device = "arn:aws:braket:::device/qpu/ionq/ionQdevice"
time_limit = 3600
```

## 4. Required Cloud Resources
The Braket executor requires some resources to be provisioned on AWS. Precisely, users will need an S3 bucket, an ECR repo, and an IAM role with the appropriate permissions to be passed to Braket.

| Config Value | Is Required |  Default| Description |
| ------------ | ----------- | ------- | ----------- |
| IAM role| Yes |  `braket_job_execution_role_name` | An IAM role granting permissions to Braket, S3, ECR, and a few other resources. |
| ECR repository| Yes  |  `ecr_image_uri` | An ECR repository for storing container images to be run by Braket. |
| s3_bucket_name | Yes  |  `s3_bucket` | An S3 bucket for storing task-specific data, such as Braket outputs or function inputs. |

One can either follow the below instructions to manually create the resources or use the provided terraform script to auto-provision the resources needed.

1. The [AWS documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/GetStartedWithS3.html) on S3 details how to configure an S3 bucket.
2. The permissions required for the the IAM role are documented in the article [“managing access to Amazon Braket”](https://docs.aws.amazon.com/braket/latest/developerguide/braket-manage-access.html). The following policy is attached to the default role “CovalentBraketJobsExecutionRole”:
3. In order to use the Braket executor plugin one must create a private ECR registry with a container image that will be used to execute the Braket jobs using covalent. One can either create an ECR repository [manually](https://docs.aws.amazon.com/AmazonECR/latest/userguide/repository-create.html) or use the terraform script provided below. We host the image in our public repository at public.ecr.aws/covalent/covalent-braket-executor:stable

<Typography style={{fontSize:'14px'}}>

:::info Note
The container image can be uploaded to a private ECR as follows

<span style={{fontSize:'12px'}}>

```azurecli
docker pull public.ecr.aws/covalent/covalent-braket-executor:stable
```

</span>

Once the image has been obtained, user’s can tag it with their registry information and upload to ECR as follows

<span style={{fontSize:'12px'}}>

```azurecli
aws ecr get-login-password --region <region> | docker login --username AWS --password-stdin <aws_account_id>.dkr.ecr.<region>.amazonaws.com
docker tag public.ecr.aws/covalent/covalent-braket-executor:stable <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<my-repository>:tag
docker push <aws_account_id>.dkr.ecr.<region>.amazonaws.com/<my-repository>:tag
```

</span>
:::

</Typography>

<details>
  <summary>Sample IAM Policy for Braket's execution role</summary>
  <div>

{
    “Version”: “2012-10-17”, “Statement”: [
>>
>>{
>>“Sid”: “VisualEditor0”, “Effect”: “Allow”, “Action”: “cloudwatch:PutMetricData”, “Resource”: “*”, “Condition”: {
>>
>>>“StringEquals”: { “cloudwatch:namespace”: “/aws/braket” }
>>
>>}
>>
>>}, {
>>>
>>>“Sid”: “VisualEditor1”, “Effect”: “Allow”, “Action”: [
>>>
>>>>“logs:CreateLogStream”, “logs:DescribeLogStreams”, “ecr:GetDownloadUrlForLayer”, “ecr:BatchGetImage”, “logs:StartQuery”, “logs:GetLogEvents”, “logs:CreateLogGroup”, “logs:PutLogEvents”, “ecr:BatchCheckLayerAvailability”
>>>], “Resource”: [
>>>>
>>>>“arn:aws:ecr::348041629502:repository/”, “arn:aws:logs:::log-group:/aws/braket*”
>>>
>>>]
>>>
>>}, {
>>>
>>>“Sid”: “VisualEditor2”, “Effect”: “Allow”, “Action”: “iam:PassRole”, “Resource”: “arn:aws:iam::348041629502:role/CovalentBraketJobsExecutionRole”, “Condition”: {
>>>
>>>>“StringLike”: { “iam:PassedToService”: “braket.amazonaws.com” }
>>>
>>>}
>>
>>}, {
>>>
>>>“Sid”: “VisualEditor3”, “Effect”: “Allow”, “Action”: [
>>>
>>>>“braket:SearchDevices”, “s3:CreateBucket”, “ecr:BatchDeleteImage”, “ecr:BatchGetRepositoryScanningConfiguration”, “ecr:DeleteRepository”, “ecr:TagResource”, “ecr:BatchCheckLayerAvailability”, “ecr:GetLifecyclePolicy”, “braket:CreateJob”, “ecr:DescribeImageScanFindings”, “braket:GetJob”, “ecr:CreateRepository”, “ecr:PutImageScanningConfiguration”, “ecr:GetDownloadUrlForLayer”, “ecr:DescribePullThroughCacheRules”, “ecr:GetAuthorizationToken”, “ecr:DeleteLifecyclePolicy”, “braket:ListTagsForResource”, “ecr:PutImage”, “s3:PutObject”, “s3:GetObject”, “braket:GetDevice”, “ecr:UntagResource”, “ecr:BatchGetImage”, “ecr:DescribeImages”, “braket:CancelQuantumTask”, “ecr:StartLifecyclePolicyPreview”, “braket:CancelJob”, “ecr:InitiateLayerUpload”, “ecr:PutImageTagMutability”, “ecr:StartImageScan”, “ecr:DescribeImageReplicationStatus”, “ecr:ListTagsForResource”, “s3:ListBucket”, “ecr:UploadLayerPart”, “ecr:CreatePullThroughCacheRule”, “ecr:ListImages”, “ecr:GetRegistryScanningConfiguration”, “braket:TagResource”, “ecr:CompleteLayerUpload”, “ecr:DescribeRepositories”, “ecr:ReplicateImage”, “ecr:GetRegistryPolicy”, “ecr:PutLifecyclePolicy”, “s3:PutBucketPublicAccessBlock”, “ecr:GetLifecyclePolicyPreview”, “ecr:DescribeRegistry”, “braket:SearchJobs”, “braket:CreateQuantumTask”, “iam:ListRoles”, “ecr:PutRegistryScanningConfiguration”, “ecr:DeletePullThroughCacheRule”, “braket:UntagResource”, “ecr:BatchImportUpstreamImage”, “braket:GetQuantumTask”, “s3:PutBucketPolicy”, “braket:SearchQuantumTasks”, “ecr:GetRepositoryPolicy”, “ecr:PutReplicationConfiguration”
>>
>>>], “Resource”: “*”
>>
>>}, {
>>
>>“Sid”: “VisualEditor4”, “Effect”: “Allow”, “Action”: “logs:GetQueryResults”, “Resource”: “arn:aws:logs:::log-group:*”
>>
>>}, {
>>
>>> “Sid”: “VisualEditor5”, “Effect”: “Allow”, “Action”: “logs:StopQuery”, “Resource”: “arn:aws:logs:::log-group:/aws/braket*”
>>
>>}
>>
>]

}

  </div>
</details>

Users can use the following [Terraform](https://www.terraform.io/) snippet as a starting point to spin up the required resources

```py

provider "aws" {}

data "aws_caller_identity" "current" {}


resource "aws_s3_bucket" "braket_bucket" {
        bucket        = "my-s3-bucket-name"
        force_destroy = true
}

resource "aws_ecr_repository" "braket_ecr_repo" {
        name                 = "amazon-braket-base-executor-repo"
        image_tag_mutability = "MUTABLE"

        force_delete = true
        image_scanning_configuration {
                scan_on_push = false
        }

        provisioner "local-exec" {
                command = "docker pull public.ecr.aws/covalent/covalent-braket-executor:stable && aws ecr get-login-password --region <region> | docker login --username AWS --password-stdin ${data.aws_caller_identity.current.account_id}.dkr.ecr.${var.aws_region}.amazonaws.com && docker tag public.ecr.aws/covalent/covalent-braket-executor:stable ${aws_ecr_repository.braket_ecr_repo.repository_url}:stable && docker push ${aws_ecr_repository.braket_ecr_repo.repository_url}:stable"
        }
}

resource "aws_iam_role" "braket_iam_role" {
        name = "amazon-braket-execution-role"
        assume_role_policy = jsonencode({
                Version = "2012-10-17"
                Statement = [
                {
                        Action = "sts:AssumeRole"
                        Effect = "Allow"
                        Sid    = ""
                        Principal = {
                        Service = "braket.amazonaws.com"
                        }
                },
                ]
        })
        managed_policy_arns = ["arn:aws:iam::aws:policy/AmazonBraketFullAccess"]
}

```